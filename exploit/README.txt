##############################################
### CSRF (Cross-Site Request Forgery) Demo ###
##############################################

### Dokumentenstruktur ###
- Verzeichnis exploit: Website, die die CSRF-Attacke durchführt sowie dieses README
- Verzeichnis src-vuln: Website, bei der CSRF-Attacken möglich sind
- Verzeichnis src-fixed: Gepatchte Website, CSRF-Attacken sind nicht mehr möglich
- Verzeichnis patches: Das (rekursiv erstellte) Patch-File, mit dem src-vuln gepatcht werden kann

### Installation mit Install-Skript ###
Die Installation wurde unter Ubuntu 16.04 getestet.

!! Folgende Programme müssen installiert sein !!
Ubuntu 16.04: apache2, mysql-server, php7.0-mysql, php7.0
Debian Jessie: apache2, mysql-server, php5-mysql, php5

### Installation via Install-Skript ###
sudo ./install.sh führt sämtliche unter "manuelle Installation" beschriebenen Schritte automatisiert durch.
sudo ./uninstall.sh macht alles wieder rückgängig.

Es wird vorausgesetzt, dass das Apache-Konfigurationsverzeichnis unter /etc/apache2 zu finden ist und
dass der MySQL User root existiert und dieser alle Berechtigungen hat.

### Manuelle Installation ###

Damit alle 3 Websites (in den Verzeichnissen exploit, src-vuln und src-fixed) funktionieren, muss
1. ein Webserver mit 3 VHosts laufen
2. eine Datenbank erstellt werden (für die Benutzerdaten)
3. Datenbank und Config-Datei modifiziert werden

### 1. Konfiguration des Webservers am Beispiel apache2 ###

Ablegen des Demoordners in einem vom Webserver aus erreichbaren Verzeichnis (z.B. unterhalb von /var/www/).

Hinzufügen der 3 VHost Konfigurationsdateien unter /etc/apache2/sites-available/
a) ccc-vuln.dev.conf
b) ccc-fixed.dev.conf
a) ccc-exploit.dev.conf

Dazu müssen 3 Dateien nach dem folgenden Schema erstellt werden (dies ist eine Minimalkonfiguration):

<VirtualHost *:80>
        ServerName ccc-[vuln/fixed/exploit].dev
        DocumentRoot /Pfad/Zum/Demoordner/src-[vuln/fixed/exploit]/public

        <Directory /Pfad/Zum/Demoordner/src-[vuln/fixed/exploit]/public>
                AllowOverride all
                Require all granted
        </Directory>
</VirtualHost>

Aktivieren der VHosts mit
sudo a2ensite /etc/apache2/sites-available/ccc-vuln.dev.conf
sudo a2ensite /etc/apache2/sites-available/ccc-fixed.dev.conf
sudo a2ensite /etc/apache2/sites-available/ccc-exploit.dev.conf

Apache neustarten mit service apache2 reload

### 2. Anlegen eines separaten MySQL Nutzers und Erstellen einer MySQL-Datenbank ###
mysql -u root -p
CREATE DATABASE cccdbvuln;
CREATE DATABASE cccdbfixed;
CREATE USER 'cccuser'@'localhost' IDENTIFIED BY 'insertpassword';
GRANT ALL PRIVILEGES ON cccdbvuln.* TO 'username'@'localhost';
GRANT ALL PRIVILEGES ON cccdbfixed.* TO 'username'@'localhost';
exit;

### 3. Modifizieren von Datenbank und Config-Datei ###
cd /pfad/zum/demoordner
cp src-vuln/config.example src-vuln/config.php
cp src-fixed/config.example src-fixed/config.php

In beiden Config-Dateien müssen die oben konfigurierten Datenbank-Parameter eingetragen werden.

Anschließend erfolgt das Erstellen und Seeden der Tabellen mit folgenden Befehlen:
cd /pfad/zum/demoordner/src-vuln/database/
php create-user-db.php
php seed-user-db.php

cd /pfad/zum/demoordner/src-fixed/database/
php create-user-db.php
php seed-user-db.php

Nun sollten alle 3 Websites erreichbar sein.

Die Demo-User (aus den Datenbank-Seeds) sind:
User: administrator, Passwort: nobodyknowsthis
User: testuser, Passwort: ilovesummer
User: bond007, Passwort: action4me
