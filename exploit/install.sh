#!/bin/sh

# Make sure script runs as root
if [ $(id -u) != 0 ]
then
	echo "Please run script as root"
  exit 1
fi

# Uncomment to install required packages for Ubuntu 16.04
# apt-get install apache2 mysql-server php7.0-mysql php7.0 libapache2-mod-php7.0

# Uncomment to install required packages for Debian Jessie
# apt-get install apache2 mysql-server php5-mysql php5 libapache2-mod-php5

# apache config
apache_user="$(. /etc/apache2/envvars && echo $APACHE_RUN_GROUP)"
apache_dir=/etc/apache2

# directory for website data
install_dir=/var/www/csrf-demo

# Create directory csrf-demo in /var/www and copy website data into it
cd ..
mkdir -p $install_dir
cp -R * $install_dir
chown -R $apache_user:$apache_user $install_dir
echo "Copied website data into $install_dir"

# Add vhost config files
for i in src-vuln src-fixed exploit
do
	echo "
    <VirtualHost *:80>
            ServerName ccc-$(echo $i | sed -r 's/^src-//').dev
            DocumentRoot $install_dir/$i/public

            <Directory $install_dir/$i/public>
                    AllowOverride all
                    Require all granted
            </Directory>
    </VirtualHost>
  " > $apache_dir/sites-available/ccc-$(echo $i | sed -r 's/^src-//').dev.conf
	echo "Added VHost file for $i in $apache_dir/sites-available"
done

# enable all vhost sites
cd $apache_dir/sites-available
a2ensite ccc-*.dev.conf
service apache2 reload
echo "Reloaded apache2 config."

# Generating random password for cccuser
# Added capital and lower letter, number and special char to satisfy MySQL password policy if set to high
mysql_password=A3$(< /dev/urandom tr -dc [:alnum:] | head -c16)b!

# Add cccuser to mysql and create databases cccdbfixed & cccdbvuln
echo "Please provide your MySQL root password."
mysql -u root -p -Bse "CREATE DATABASE IF NOT EXISTS cccdbvuln;
		CREATE DATABASE IF NOT EXISTS cccdbfixed;
		CREATE USER 'cccuser'@'localhost' IDENTIFIED BY '$mysql_password';
		GRANT ALL PRIVILEGES ON cccdbvuln.* TO '$mysql_user'@'localhost' IDENTIFIED BY '$mysql_password';
		GRANT ALL PRIVILEGES ON cccdbfixed.* TO '$mysql_user'@'localhost' IDENTIFIED BY '$mysql_password';
		FLUSH PRIVILEGES;
"
echo "Added database cccdbvuln and cccdbfixed, added new mysql user cccuser."

# copy config files and fill them with db parameters
for i in src-vuln src-fixed
do
		cd $install_dir/$i
		cp config.example config.php
		sed -i "s/insert server/localhost/g" config.php
		sed -i "s/insert username/cccuser/g" config.php
		sed -i "s/insert password/$mysql_password/g" config.php
		sed -i "s/insert database name/cccdb$(echo $i | sed -r 's/^src-//')/g" config.php
		echo "Configured database parameters for $i"
		cd database
		php create-user-db.php
		php seed-user-db.php
done

echo "Install complete."
