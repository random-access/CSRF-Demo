#!/bin/sh

# Make sure script runs as root
if [ $(id -u) != 0 ]
then
	echo "Please run script as root"
  exit 1
fi

# Uncomment to install required packages for Ubuntu 16.04
# sudo apt-get install apache2 mysql-server php7.0-mysql php7.0

# Uncomment to install required packages for Debian Jessie
# sudo apt-get install apache2 mysql-server php5-mysql php5

apache_user="$(. /etc/apache2/envvars && echo $APACHE_RUN_GROUP)"
apache_dir=/etc/apache2

cd ..
dir_name=${PWD##*/}
mkdir -p /var/www/csrf-demo
cp -R ../$dir_name/* /var/www/csrf-demo
chown -R $apache_user:$apache_user /var/www/csrf-demo
echo "Copied folder $dir_name into /var/www/"

# Add vhost config files
for i in src-vuln src-fixed exploit
do
	echo "
    <VirtualHost *:80>
            ServerName ccc-$(echo $i | sed -r 's/^src-//').dev
            DocumentRoot /var/www/csrf-demo/$i/public

            <Directory /var/www/csrf-demo/$i/public>
                    AllowOverride all
                    Require all granted
            </Directory>
    </VirtualHost>
  " > $apache_dir/sites-available/ccc-$(echo $i | sed -r 's/^src-//').dev.conf
	echo "Added VHost file for $i in /etc/apache2/sites-available"
done

cd $apache_dir/sites-available
a2ensite ccc-*.dev.conf

service apache2 reload
echo "Reloaded apache2 config."

echo "Creating a separate MySQL user named cccuser."
stty -echo
read -p "MySQL password for cccuser: " mysql_password; echo
stty echo
echo "Please provide your MySQL root password."
mysql -u root -p -Bse "CREATE DATABASE IF NOT EXISTS cccdbvuln;
		CREATE DATABASE IF NOT EXISTS cccdbfixed;
		CREATE USER 'cccuser'@'localhost' IDENTIFIED BY '$mysql_password';
		GRANT ALL PRIVILEGES ON cccdbvuln.* TO '$mysql_user'@'localhost' IDENTIFIED BY '$mysql_password';
		GRANT ALL PRIVILEGES ON cccdbfixed.* TO '$mysql_user'@'localhost' IDENTIFIED BY '$mysql_password';
		FLUSH PRIVILEGES;
"
echo "Added database cccdbvuln and cccdbfixed."

for i in src-vuln src-fixed
do
		cd /var/www/csrf-demo/$i
		cp config.example config.php
		sed -i "s/insert server/localhost/g" config.php
		sed -i "s/insert username/cccuser/g" config.php
		sed -i "s/insert password/$mysql_password/g" config.php
		sed -i "s/insert database name/cccdb$(echo $i | sed -r 's/^src-//')/g" config.php
		echo "Configured database parameters for $i"
		cd database
		php create-user-db.php
		php seed-user-db.php
done

echo "Install complete."
